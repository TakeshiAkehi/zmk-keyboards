# ZMK Firmware Build Automation

## Overview
This script automates the process of building firmware for ZMK-based keyboard configurations using Docker containers. It handles initializing, updating, and building firmware from configuration files.

## Prerequisites

Ensure you have the following installed on your system:

- Python 3.8+
- Docker
- Required Python libraries:
  - `docker`
  - `pyyaml`

You can install the required Python dependencies using:
```sh
pip install docker pyyaml
```

## Usage

### Running the Script

The script is executed with a YAML configuration file that specifies the build process.

```sh
python build.py <path_to_yaml>
```

### Options

- `--init`: Initializes a new container and project setup
- `--update`: Updates the existing setup
- `--prinstine, -p`: Forces a pristine build

Example:
```sh
python build.py keyboards/zmk-config-d3kb2/build.yaml --init
```

### Arguments

| Argument     | Description |
|-------------|-------------|
| `build_yaml` | Path to the build YAML configuration file |
| `--init` | Initializes the workspace and starts a new container |
| `--update` | Updates the ZMK repository inside the container |
| `--prinstine, -p` | Forces a clean rebuild |

## Project Structure

```plaintext
.
├── build.py                # Main build script
├── keyboards/
│   ├── zmk-config-d3kb2/   # Example keyboard configuration
│   │   ├── build.yaml      # Build configuration file
│   │   ├── boards/         # Board files
│   │   ├── config/         # Configurations
│   ├── zmk-config-other/   # Other configurations
├── zmk_work/                  # Build workspaces (per keyboard)
│   ├── zmk-config-d3kb2/     # Build workspace for d3kb2
│   ├── zmk-config-other/     # Build workspace for other keyboards
└── README.md               # Documentation
```

## How It Works

1. **Container Setup**
   - A Docker container (`zmkfirmware/zmk-dev-arm:4.1`) is pulled and initialized.
   - The required directories are mounted inside the container.
   - The container executes commands via `exec` for build steps.

2. **Initialization (`--init`)**
   - The working directory is created at `zmk_work/<keyboard-name>/` in the repository root.
   - The ZMK project is initialized using `west init`.
   - Configuration files are copied into the workspace.

3. **Updating (`--update`)**
   - Updates the ZMK repository using `west update`.

4. **Building Firmware**
   - Board and shield configurations are parsed from `build.yaml`.
   - The build process runs inside the container using `west build`.
   - Compiled firmware (`.uf2` files) is copied to the `zmk_work/<keyboard-name>/` directory.

## Example YAML Configuration

An example `build.yaml` file that defines build targets:

```yaml
include:
  - board: nice_nano_v2
    shield: my_keyboard_left
  - board: nice_nano_v2
    shield: my_keyboard_right
```

## Troubleshooting

### Docker Issues
- Ensure Docker is running before executing the script.
- If a container is already running, the script will reuse it unless `--init` is specified.
- If you need to remove an existing container, pass `force_new=True` in the script.

### Build Failures
- If the firmware build fails, check if `zmk.uf2` was generated in `zmk_work/<keyboard-name>/zmk/build/`.
- Ensure all board and shield definitions are correct in `build.yaml`.

## License
This project is open-source and provided under the MIT license.

## Contributing
Feel free to open issues and submit pull requests to improve the script!


(This document is generated by ChatGPT)