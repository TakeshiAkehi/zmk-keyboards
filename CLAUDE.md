# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

This is a ZMK keyboard firmware build environment that enables local Docker-based builds for faster iteration compared to GitHub Actions. Keyboard configurations are stored as git submodules following the [unified-zmk-config-template](https://github.com/zmkfirmware/unified-zmk-config-template) structure.

## Build Commands

```bash
# Build firmware (most common — after keymap changes)
./build.zsh keyboards/<keyboard-name>/build.yaml -p

# First-time setup for a keyboard (initializes west workspace)
./build.zsh --init keyboards/<keyboard-name>/build.yaml

# Update ZMK sources after editing west.yml
./build.zsh --update keyboards/<keyboard-name>/build.yaml

# Build multiple keyboards at once
./build.zsh keyboards/zmk-config-fish/build.yaml keyboards/zmk-config-d3kb2/build.yaml -p

# Interactive keyboard selection with fzf (no arguments)
./build.zsh
```

Output `.uf2` files are placed in `zmk_work/<keyboard-name>/`.

## Adding a New Keyboard

```bash
./add_keyboard.bash <repo-name>
```

This clones the unified-zmk-config-template, initializes a new git repo, pushes to GitHub, and adds it as a submodule.

## Local Module Override

Place ZMK/Zephyr modules in `zmk_modules/` at the repository root for local development without pushing to a remote:

```
zmk_modules/
└── my-module/
    └── zephyr/module.yml    # Required — modules without this are ignored
```

Modules are auto-detected and injected via `-DEXTRA_ZEPHYR_MODULES`. Existing Docker containers are recreated automatically when `zmk_modules/` is added. The directory is gitignored and mounted read-only in containers.

## Architecture

### Build Flow

1. `build.zsh` parses `build.yaml` for board/shield combinations (using `yq`)
2. Docker container (`zmkfirmware/zmk-dev-arm:4.1`) is started with `zmk_work/<keyboard-name>/` mounted
3. `west init -l config/` initializes the workspace (on `--init`)
4. `west update` fetches ZMK and dependencies
5. Local modules from `zmk_modules/` are detected and passed via `EXTRA_ZEPHYR_MODULES`
6. `west build` compiles each shield, producing `.uf2` files

### Keyboard Configuration Structure

Each submodule in `keyboards/` follows this structure:
```
zmk-config-<name>/
├── build.yaml              # Build targets (board, shield, cmake-args, artifact-name)
├── config/
│   └── west.yml           # West manifest (ZMK version, extra modules)
└── boards/shields/<name>/ # Shield definitions (.overlay, .keymap, .conf, .dtsi)
```

Build workspaces are created at `zmk_work/<keyboard-name>/` in the repository root (not inside submodules).

### build.yaml Format

```yaml
include:
  - board: seeeduino_xiao_ble
    shield: my_keyboard_left
  - board: seeeduino_xiao_ble
    shield: my_keyboard_left
    artifact-name: my_keyboard_left_central   # Custom output filename
    cmake-args: -DCONFIG_ZMK_SPLIT_ROLE_CENTRAL=y
    snippet: zmk-usb-logging                  # Optional Zephyr snippet
```

### Docker Container Lifecycle

- Container name matches the keyboard config directory name
- Containers are reused unless `--init` creates a fresh one
- Containers are automatically recreated if `zmk_modules/` exists but is not mounted
- `close_all_container.bash` can clean up all containers

## Prerequisites

- Docker daemon running
- [yq](https://github.com/mikefarah/yq) (Mike Farah version) — YAML parsing
- [fzf](https://github.com/junegunn/fzf) — interactive keyboard selection (optional)
- zsh — build script runtime

## Rules

- Build firmware with `./build.zsh`, not `build.py` (the Python script is obsolete)
- Do not modify files under `zmk_work/` — this directory is generated by the build process and gitignored
- Do not commit `zmk_modules/` — it is for local development only and gitignored
