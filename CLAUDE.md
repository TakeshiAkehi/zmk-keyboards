# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

This is a ZMK keyboard firmware build environment that uses [`act`](https://github.com/nektos/act) to run GitHub Actions workflows locally for faster iteration compared to cloud CI. Keyboard configurations are stored as git submodules following the [unified-zmk-config-template](https://github.com/zmkfirmware/unified-zmk-config-template) structure.

## Build Commands

```bash
# Build firmware (most common — after keymap changes)
./build.sh keyboards/<keyboard-name>/build.yaml -p

# First-time setup for a keyboard (initializes west workspace)
./build.sh --init keyboards/<keyboard-name>/build.yaml

# Update ZMK sources after editing west.yml
./build.sh --update keyboards/<keyboard-name>/build.yaml

# Interactive keyboard selection with fzf (no arguments)
./build.sh

# Override container image
ZMK_DOCKER_IMAGE=zmkfirmware/zmk-dev-arm:4.1 ./build.sh keyboards/<keyboard-name>/build.yaml -p
```

Output `.uf2` files are placed in `zmk_work/<keyboard-name>/`.

## Adding a New Keyboard

```bash
./add_keyboard.bash <repo-name>
```

This clones the unified-zmk-config-template, initializes a new git repo, pushes to GitHub, and adds it as a submodule.

## Local Module Override

Place ZMK/Zephyr modules in `zmk_modules/` at the repository root for local development without pushing to a remote:

```
zmk_modules/
└── my-module/
    └── zephyr/module.yml    # Required — modules without this are ignored
```

Modules are auto-detected by the build workflow and injected via `-DEXTRA_ZEPHYR_MODULES`. The directory is gitignored and automatically available inside the `act` container via bind mount.

## Architecture

### Build Flow

1. `build.sh` parses `build.yaml` for board/shield combinations (using `yq`)
2. Host-side: config and board files are copied to `zmk_work/<keyboard-name>/zmk/`
3. For each build target, `act` runs `.github/workflows/build-local.yml` with `--bind`
4. Inside the container (`zmkfirmware/zmk-build-arm:stable` by default):
   - `west init -l config/` initializes the workspace (on `--init`)
   - `west update` fetches ZMK and dependencies (on `--init` or `--update`)
   - `west zephyr-export` prepares the build environment
   - Local modules from `zmk_modules/` are auto-detected and passed via `EXTRA_ZEPHYR_MODULES`
   - `west build` compiles the shield, producing a `.uf2` file
5. Output `.uf2` is copied to `zmk_work/<keyboard-name>/`

### Keyboard Configuration Structure

Each submodule in `keyboards/` follows this structure:
```
zmk-config-<name>/
├── build.yaml              # Build targets (board, shield, cmake-args, artifact-name)
├── config/
│   └── west.yml           # West manifest (ZMK version, extra modules)
└── boards/shields/<name>/ # Shield definitions (.overlay, .keymap, .conf, .dtsi)
```

Build workspaces are created at `zmk_work/<keyboard-name>/` in the repository root (not inside submodules).

### build.yaml Format

```yaml
include:
  - board: seeeduino_xiao_ble
    shield: my_keyboard_left
  - board: seeeduino_xiao_ble
    shield: my_keyboard_left
    artifact-name: my_keyboard_left_central   # Custom output filename
    cmake-args: -DCONFIG_ZMK_SPLIT_ROLE_CENTRAL=y
    snippet: zmk-usb-logging                  # Optional Zephyr snippet
```

### act Container Lifecycle

- Containers are ephemeral — created per `act` invocation and removed after completion
- Workspace persistence comes from `act --bind`, which bind-mounts the repo root
- `zmk_work/` directories persist on the host filesystem between builds
- No container management needed (unlike the previous Docker-based approach)

## Prerequisites

- Docker daemon running (used by `act` internally)
- [`act`](https://github.com/nektos/act) — local GitHub Actions runner
- [yq](https://github.com/mikefarah/yq) (Mike Farah version) — YAML parsing
- [fzf](https://github.com/junegunn/fzf) — interactive keyboard selection (optional)
- bash or zsh — build script runtime

## Rules

- Build firmware with `./build.sh`, not `build.py` (the Python script is obsolete)
- Do not modify files under `zmk_work/` — this directory is generated by the build process and gitignored
- Do not commit `zmk_modules/` — it is for local development only and gitignored
